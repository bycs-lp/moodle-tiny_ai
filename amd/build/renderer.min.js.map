{"version":3,"file":"renderer.min.js","sources":["../src/renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny AI utils library.\n *\n * @module      tiny_ai/renderer\n * @copyright   2024, ISB Bayern\n * @author      Philipp Memmel\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {renderInfoBox} from 'local_ai_manager/infobox';\nimport {renderUserQuota} from 'local_ai_manager/userquota';\nimport * as BasedataHandler from 'tiny_ai/datahandler/basedata';\nimport Templates from 'core/templates';\nimport DataManager from 'tiny_ai/datamanager';\nimport SummarizeHandler from 'tiny_ai/datahandler/summarize';\nimport TranslateHandler from 'tiny_ai/datahandler/translate';\nimport TtsHandler from 'tiny_ai/datahandler/tts';\nimport ImggenHandler from 'tiny_ai/datahandler/imggen';\nimport StartHandler from 'tiny_ai/datahandler/start';\nimport OptimizeHandler from './datahandler/optimize';\nimport $ from 'jquery';\n\n\nlet modal = null;\nlet userId = null;\n\nexport const init = async (existingModal) => {\n    modal = existingModal;\n    await BasedataHandler.init();\n    await StartHandler.init();\n};\n\nexport const renderStart = async () => {\n    DataManager.reset();\n    const templateContext = await StartHandler.getTemplateContext();\n    await renderModalContent('moodle-modal-body-start', 'moodle-modal-footer-info', templateContext);\n};\n\nexport const renderSummarize = async () => {\n    const templateContext = SummarizeHandler.getTemplateContext('summarize');\n    await renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderTranslate = async () => {\n    const templateContext = TranslateHandler.getTemplateContext();\n    await renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderDescribe = async () => {\n    const templateContext = SummarizeHandler.getTemplateContext('describe');\n    await renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderTts = async () => {\n    const templateContext = await TtsHandler.getTemplateContext('tts');\n    await renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderAudiogen = async () => {\n    const templateContext = await TtsHandler.getTemplateContext('audiogen');\n    await renderModalContent('moodle-modal-body-mediageneration', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderImggen = async () => {\n    const templateContext = await ImggenHandler.getTemplateContext();\n    await renderModalContent('moodle-modal-body-mediageneration', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderLoading = async () => {\n    const templateContext = {};\n    templateContext.modal_headline = BasedataHandler.getTinyAiString('aigenerating');\n    await renderModalContent('moodle-modal-body-loading', 'moodle-modal-footer-empty', templateContext);\n};\n\nexport const renderSuggestion = async () => {\n    const templateContext = {};\n    templateContext.modal_headline = BasedataHandler.getTinyAiString('aisuggestion');\n    // TODO Eventually do not use the same rendering in the suggestion like in the course, or just leave it because we\n    //  consider it beautiful\n    templateContext.result_text = renderAiResultForEditor();\n\n    Object.assign(templateContext, BasedataHandler.getReplaceButtonsContext());\n    await renderModalContent('moodle-modal-body-suggestion', 'moodle-modal-footer-replace', templateContext);\n};\n\nexport const renderOptimizePrompt = async () => {\n    const templateContext = OptimizeHandler.getTemplateContext();\n    await renderModalContent('moodle-modal-body-optimize', 'moodle-modal-footer-generate', templateContext);\n};\n\nexport const renderDismiss = async() => {\n    const templateContext = {\n        modal_headline: '',\n        centered_headline: BasedataHandler.getTinyAiString('dismisssuggestion'),\n        showIcon: false,\n        buttons: [\n            {\n                hasText: true,\n                button_text: BasedataHandler.getTinyAiString('cancel'),\n                icon_left: false,\n                icon_right: false,\n                primary: false,\n                secondary: true,\n                tertiary: false,\n                action: 'canceldismiss'\n            },\n            {\n                hasText: true,\n                button_text: BasedataHandler.getTinyAiString('dismiss'),\n                icon_left: false,\n                icon_right: false,\n                primary: true,\n                secondary: false,\n                tertiary: false,\n                action: 'dismiss'\n            }\n        ]\n    };\n    await renderModalContent('moodle-modal-body-dismiss', 'moodle-modal-footer-empty', templateContext);\n};\n\nexport const renderAiResultForEditor = () => {\n    let html;\n    switch (DataManager.getCurrentTool()) {\n        case 'tts':\n        case 'audiogen': {\n            const audioPlayer = document.createElement('audio');\n            audioPlayer.controls = 'controls';\n            audioPlayer.src = DataManager.getCurrentAiResult();\n            audioPlayer.type = 'audio/mpeg';\n            html = audioPlayer.outerHTML;\n            break;\n        }\n        case 'imggen': {\n            const img = document.createElement('img');\n            img.src = DataManager.getCurrentAiResult();\n            img.classList.add('mw-100');\n            html = img.outerHTML;\n            break;\n        }\n        default: {\n            html = DataManager.getCurrentAiResult();\n        }\n    }\n    return html;\n};\n\n/**\n * Re-renders the content auf the modal once it has been created.\n *\n * @param {string} bodyComponentTemplate the name of the body template to use (without the prefix 'tiny_ai/components/')\n * @param {string} footerComponentTemplate the name of the footer template to use (without the prefix 'tiny_ai/components/')\n * @param {string} templateContext the template context being used for all partial templates\n * @returns {Promise<void>} the async promise\n */\nexport const renderModalContent = async (bodyComponentTemplate, footerComponentTemplate, templateContext) => {\n    const result = await Promise.all([\n        Templates.renderForPromise('tiny_ai/components/moodle-modal-header-title', templateContext),\n        Templates.renderForPromise('tiny_ai/components/' + bodyComponentTemplate, templateContext),\n        Templates.renderForPromise('tiny_ai/components/' + footerComponentTemplate, templateContext)\n    ]);\n    if (templateContext.hasOwnProperty('modal_headline')) {\n        // If there is no headline specified, we keep the old one.\n        modal.setTitle(result[0].html);\n    }\n    // Hide all eventually still existing tooltips first, because they show on 'hover' and\n    // 'focus'. So we need to remove them before removing the corresponding buttons from the DOM.\n    // Boostrap 4 still using jQuery for tooltips, so we need jQuery here.\n    document.querySelectorAll('button[data-action]').forEach(button => {\n        $(button).tooltip('hide');\n    });\n    modal.setBody(result[1].html);\n    modal.setFooter(result[2].html);\n    result.forEach((item) => {\n        Templates.runTemplateJS(item.js);\n    });\n    await insertInfoBox();\n    await insertUserQuotaBox();\n    document.querySelectorAll('button[data-action]').forEach(button => {\n        button.addEventListener('click', event => {\n            $(event.target).closest('button[data-action]').tooltip('hide');\n        });\n    });\n};\n\nexport const insertInfoBox = async () => {\n    const infoBoxSelector = '[data-rendertarget=\"infobox\"]';\n    if (document.querySelector(infoBoxSelector)) {\n        await renderInfoBox('tiny_ai', userId, infoBoxSelector, ['singleprompt', 'translate', 'tts', 'imggen']);\n    }\n};\n\nexport const insertUserQuotaBox = async () => {\n    const usageBoxSelector = '[data-rendertarget=\"usageinfo\"]';\n    if (document.querySelector(usageBoxSelector)) {\n        await renderUserQuota(usageBoxSelector, ['singleprompt', 'translate', 'tts', 'imggen']);\n    }\n};\n"],"names":["modal","async","existingModal","BasedataHandler","init","StartHandler","reset","templateContext","getTemplateContext","renderModalContent","SummarizeHandler","TranslateHandler","TtsHandler","ImggenHandler","modal_headline","getTinyAiString","result_text","renderAiResultForEditor","Object","assign","getReplaceButtonsContext","OptimizeHandler","centered_headline","showIcon","buttons","hasText","button_text","icon_left","icon_right","primary","secondary","tertiary","action","html","DataManager","getCurrentTool","audioPlayer","document","createElement","controls","src","getCurrentAiResult","type","outerHTML","img","classList","add","bodyComponentTemplate","footerComponentTemplate","result","Promise","all","Templates","renderForPromise","hasOwnProperty","setTitle","querySelectorAll","forEach","button","tooltip","setBody","setFooter","item","runTemplateJS","js","insertInfoBox","insertUserQuotaBox","addEventListener","event","target","closest","querySelector"],"mappings":"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"}