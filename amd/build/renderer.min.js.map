{"version":3,"file":"renderer.min.js","sources":["../src/renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny AI utils library.\n *\n * @module      tiny_ai/renderer\n * @copyright   2024, ISB Bayern\n * @author      Philipp Memmel\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {renderInfoBox} from 'local_ai_manager/infobox';\nimport {renderUserQuota} from 'local_ai_manager/userquota';\nimport * as BasedataHandler from 'tiny_ai/datahandler/basedata';\nimport Templates from 'core/templates';\nimport SummarizeHandler from 'tiny_ai/datahandler/summarize';\nimport TranslateHandler from 'tiny_ai/datahandler/translate';\nimport TtsHandler from 'tiny_ai/datahandler/tts';\nimport ImggenHandler from 'tiny_ai/datahandler/imggen';\nimport StartHandler from 'tiny_ai/datahandler/start';\nimport OptimizeHandler from './datahandler/optimize';\nimport $ from 'jquery';\nimport {getEditorUtils, getDatamanager} from 'tiny_ai/utils';\n\nexport default class {\n\n    uniqid = null;\n    datamanager = null;\n    editorUtils = null;\n\n    constructor(uniqid) {\n        this.uniqid = uniqid;\n        this.datamanager = getDatamanager(uniqid);\n        this.editorUtils = getEditorUtils(uniqid);\n    }\n\n    async init() {\n        await BasedataHandler.init(this.uniqid);\n        await StartHandler.init(this.uniqid);\n    }\n\n    async renderStart() {\n        this.datamanager.reset();\n        const templateContext = await StartHandler.getTemplateContext(getEditorUtils(this.uniqid));\n        await this.renderModalContent('moodle-modal-body-start', 'moodle-modal-footer-info', templateContext);\n    }\n\n\n    async renderSummarize() {\n        const templateContext = SummarizeHandler.getTemplateContext('summarize');\n        await this.renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n    }\n\n\n    async renderTranslate() {\n        const templateContext = TranslateHandler.getTemplateContext();\n        await this.renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n    }\n\n    async renderDescribe() {\n        const templateContext = SummarizeHandler.getTemplateContext('describe');\n        await this.renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n    }\n\n    async renderTts(){\n        const templateContext = await TtsHandler.getTemplateContext('tts');\n        await this.renderModalContent('moodle-modal-body-preferences', 'moodle-modal-footer-generate', templateContext);\n    }\n\n    async renderAudiogen(){\n        const templateContext = await TtsHandler.getTemplateContext('audiogen');\n        await this.renderModalContent('moodle-modal-body-mediageneration', 'moodle-modal-footer-generate', templateContext);\n    }\n\n\n    async renderImggen() {\n        const templateContext = await ImggenHandler.getTemplateContext();\n        await this.renderModalContent('moodle-modal-body-mediageneration', 'moodle-modal-footer-generate', templateContext);\n    }\n\n    async renderLoading() {\n        const templateContext = {};\n        templateContext.modal_headline = BasedataHandler.getTinyAiString('aigenerating');\n        await this.renderModalContent('moodle-modal-body-loading', 'moodle-modal-footer-empty', templateContext);\n    }\n\n\n    async renderSuggestion() {\n        const templateContext = {};\n        templateContext.modal_headline = BasedataHandler.getTinyAiString('aisuggestion');\n        // TODO Eventually do not use the same rendering in the suggestion like in the course, or just leave it because we\n        //  consider it beautiful\n        templateContext.result_text = this.renderAiResultForEditor();\n\n        Object.assign(templateContext, BasedataHandler.getReplaceButtonsContext(this.editorUtils.getMode()));\n        await this.renderModalContent('moodle-modal-body-suggestion', 'moodle-modal-footer-replace', templateContext);\n    }\n\n    async renderOptimizePrompt() {\n        const templateContext = OptimizeHandler.getTemplateContext();\n        await this.renderModalContent('moodle-modal-body-optimize', 'moodle-modal-footer-generate', templateContext);\n    }\n\n\n    async renderDismiss() {\n        const templateContext = {\n            modal_headline: '',\n            centered_headline: BasedataHandler.getTinyAiString('dismisssuggestion'),\n            showIcon: false,\n            buttons: [\n                {\n                    hasText: true,\n                    button_text: BasedataHandler.getTinyAiString('cancel'),\n                    icon_left: false,\n                    icon_right: false,\n                    primary: false,\n                    secondary: true,\n                    tertiary: false,\n                    action: 'canceldismiss'\n                },\n                {\n                    hasText: true,\n                    button_text: BasedataHandler.getTinyAiString('dismiss'),\n                    icon_left: false,\n                    icon_right: false,\n                    primary: true,\n                    secondary: false,\n                    tertiary: false,\n                    action: 'dismiss'\n                }\n            ]\n        };\n        await this.renderModalContent('moodle-modal-body-dismiss', 'moodle-modal-footer-empty', templateContext);\n    }\n\n\n    renderAiResultForEditor() {\n        let html;\n        switch (this.datamanager.getCurrentTool()) {\n            case 'tts':\n            case 'audiogen': {\n                const audioPlayer = document.createElement('audio');\n                audioPlayer.controls = 'controls';\n                audioPlayer.src = this.datamanager.getCurrentAiResult();\n                audioPlayer.type = 'audio/mpeg';\n                html = audioPlayer.outerHTML;\n                break;\n            }\n            case 'imggen': {\n                const img = document.createElement('img');\n                img.src = this.datamanager.getCurrentAiResult();\n                img.classList.add('mw-100');\n                html = img.outerHTML;\n                break;\n            }\n            default: {\n                html = this.datamanager.getCurrentAiResult();\n            }\n        }\n        return html;\n    }\n\n    /**\n     * Re-renders the content auf the modal once it has been created.\n     *\n     * @param {string} bodyComponentTemplate the name of the body template to use (without the prefix 'tiny_ai/components/')\n     * @param {string} footerComponentTemplate the name of the footer template to use (without the prefix 'tiny_ai/components/')\n     * @param {string} templateContext the template context being used for all partial templates\n     * @returns {Promise<void>} the async promise\n     */\n    async renderModalContent(bodyComponentTemplate, footerComponentTemplate, templateContext) {\n        const modal = getEditorUtils(this.uniqid).getModal();\n        const result = await Promise.all([\n            Templates.renderForPromise('tiny_ai/components/moodle-modal-header-title', templateContext),\n            Templates.renderForPromise('tiny_ai/components/' + bodyComponentTemplate, templateContext),\n            Templates.renderForPromise('tiny_ai/components/' + footerComponentTemplate, templateContext)\n        ]);\n        if (templateContext.hasOwnProperty('modal_headline')) {\n            // If there is no headline specified, we keep the old one.\n            modal.setTitle(result[0].html);\n        }\n        // Hide all eventually still existing tooltips first, because they show on 'hover' and\n        // 'focus'. So we need to remove them before removing the corresponding buttons from the DOM.\n        // Boostrap 4 still using jQuery for tooltips, so we need jQuery here.\n        document.querySelectorAll('button[data-action]').forEach(button => {\n            $(button).tooltip('hide');\n        });\n        modal.setBody(result[1].html);\n        modal.setFooter(result[2].html);\n        result.forEach((item) => {\n            Templates.runTemplateJS(item.js);\n        });\n        await this.insertInfoBox();\n        await this.insertUserQuotaBox();\n        document.querySelectorAll('button[data-action]').forEach(button => {\n            button.addEventListener('click', event => {\n                $(event.target).closest('button[data-action]').tooltip('hide');\n            });\n        });\n    }\n\n    async insertInfoBox(){\n        const infoBoxSelector = '[data-rendertarget=\"infobox\"]';\n        if (document.querySelector(infoBoxSelector)) {\n            await renderInfoBox('tiny_ai', getEditorUtils(this.uniqid).getUserId(), infoBoxSelector,\n                ['singleprompt', 'translate', 'tts', 'imggen']);\n        }\n    }\n\n    async insertUserQuotaBox() {\n        const usageBoxSelector = '[data-rendertarget=\"usageinfo\"]';\n        if (document.querySelector(usageBoxSelector)) {\n            await renderUserQuota(usageBoxSelector, ['singleprompt', 'translate', 'tts', 'imggen']);\n        }\n    }\n}\n"],"names":["constructor","uniqid","datamanager","editorUtils","BasedataHandler","init","this","StartHandler","reset","templateContext","getTemplateContext","renderModalContent","SummarizeHandler","TranslateHandler","TtsHandler","ImggenHandler","modal_headline","getTinyAiString","result_text","renderAiResultForEditor","Object","assign","getReplaceButtonsContext","getMode","OptimizeHandler","centered_headline","showIcon","buttons","hasText","button_text","icon_left","icon_right","primary","secondary","tertiary","action","html","getCurrentTool","audioPlayer","document","createElement","controls","src","getCurrentAiResult","type","outerHTML","img","classList","add","bodyComponentTemplate","footerComponentTemplate","modal","getModal","result","Promise","all","Templates","renderForPromise","hasOwnProperty","setTitle","querySelectorAll","forEach","button","tooltip","setBody","setFooter","item","runTemplateJS","js","insertInfoBox","insertUserQuotaBox","addEventListener","event","target","closest","querySelector","getUserId"],"mappings":"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"}