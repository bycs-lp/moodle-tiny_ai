{"version":3,"file":"editor_utils.min.js","sources":["../src/editor_utils.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Editor instance specific utils.\n *\n * @module      tiny_ai/editor_utils\n * @copyright   2024, ISB Bayern\n * @author      Philipp Memmel\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport AiModal from 'tiny_ai/modal';\nimport ModalEvents from 'core/modal_events';\nimport {getUserId} from 'tiny_ai/options';\nimport {constants} from 'tiny_ai/constants';\nimport {selectionbarSource, toolbarSource, menubarSource} from 'tiny_ai/common';\nimport {getDraftItemId as getDraftItemIdTinyCore, getContextId as getContextItemIdTinyCore} from 'editor_tiny/options';\nimport {getRenderer, getDatamanager} from 'tiny_ai/utils';\n\nexport default class {\n\n    uniqid = null;\n    userId = null;\n    modal = null;\n    mode = null;\n    editor = null;\n\n    constructor(uniqid, editor) {\n        this.uniqid = uniqid;\n        this.editor = editor;\n        this.userId = getUserId(editor);\n    }\n\n    /**\n     * Shows and handles the dialog.\n     *\n     * @param {string} source the different sources from where the modal is being created, defined in common module\n     */\n    async displayDialogue(source) {\n        if (source === selectionbarSource || this.editor.selection.getContent().length > 0) {\n            this.mode = constants.modalModes.selection;\n        } else if (source === toolbarSource || source === menubarSource) {\n            this.mode = constants.modalModes.general;\n        }\n\n        // We initially render the modal without content, because we need to rerender it anyway.\n        this.modal = await AiModal.create({\n            templateContext: {\n                classes: 'tiny_ai-modal--dialog',\n                headerclasses: 'tiny_ai-modal--header'\n            }\n        });\n        this.modal.show();\n        const renderer = getRenderer(this.uniqid);\n\n        getDatamanager(this.uniqid).setSelectionImg(null);\n        if (this.mode === constants.modalModes.selection) {\n            const selectedEditorContentHtml = this.editor.selection.getContent({format: 'html'});\n            const parser = new DOMParser();\n            const editorDom = parser.parseFromString(selectedEditorContentHtml, 'text/html');\n            const images = editorDom.querySelectorAll('img');\n\n            if (images.length > 0 && images[0].src) {\n                // If there are more than one we just use the first one.\n                const image = images[0];\n                // This should work for both external and data urls.\n                const fetchResult = await fetch(image.src);\n                const data = await fetchResult.blob();\n                getDatamanager(this.uniqid).setSelectionImg(data);\n            }\n            getDatamanager(this.uniqid).setSelection(this.editor.selection.getContent());\n        }\n        // Unfortunately, the modal will not execute any JS code in the template, so we need to rerender the modal as a whole again.\n        await renderer.renderStart();\n        this.modal.getRoot().on(ModalEvents.outsideClick, event => {\n            event.preventDefault();\n        });\n    }\n\n\n    insertAfterContent(textToInsert) {\n        this.editor.setContent(this.editor.getContent() + '<p>' + textToInsert + '</p>');\n    }\n\n    /**\n     * Replaces a selected text with the given replacement.\n     *\n     * In case nothing is selected, it will be inserted at the current caret position.\n     *\n     * @param {strings} textReplacement the text by which the current selection will be replaced or which will be inserted\n     *  at the caret (if no selection), can be HTML code\n     */\n    replaceSelection(textReplacement) {\n        this.editor.selection.setContent(textReplacement);\n    }\n\n    getDraftItemId() {\n        return getDraftItemIdTinyCore(this.editor);\n    }\n\n    getContextId() {\n        return getContextItemIdTinyCore(this.editor);\n    }\n\n    getMode() {\n        return this.mode;\n    }\n\n    getModal() {\n        return this.modal;\n    }\n\n    getUserId() {\n        return this.userId;\n    }\n\n}\n"],"names":["constructor","uniqid","editor","userId","source","selectionbarSource","this","selection","getContent","length","mode","constants","modalModes","toolbarSource","menubarSource","general","modal","AiModal","create","templateContext","classes","headerclasses","show","renderer","setSelectionImg","selectedEditorContentHtml","format","images","DOMParser","parseFromString","querySelectorAll","src","image","fetchResult","fetch","data","blob","setSelection","renderStart","getRoot","on","ModalEvents","outsideClick","event","preventDefault","insertAfterContent","textToInsert","setContent","replaceSelection","textReplacement","getDraftItemId","getContextId","getMode","getModal","getUserId"],"mappings":"+rBAwCIA,YAAYC,OAAQC,sCANX,oCACA,mCACD,kCACD,oCACE,WAGAD,OAASA,YACTC,OAASA,YACTC,QAAS,sBAAUD,8BAQNE,QACdA,SAAWC,4BAAsBC,KAAKJ,OAAOK,UAAUC,aAAaC,OAAS,OACxEC,KAAOC,qBAAUC,WAAWL,UAC1BH,SAAWS,uBAAiBT,SAAWU,6BACzCJ,KAAOC,qBAAUC,WAAWG,cAIhCC,YAAcC,eAAQC,OAAO,CAC9BC,gBAAiB,CACbC,QAAS,wBACTC,cAAe,gCAGlBL,MAAMM,aACLC,UAAW,sBAAYjB,KAAKL,qCAEnBK,KAAKL,QAAQuB,gBAAgB,MACxClB,KAAKI,OAASC,qBAAUC,WAAWL,UAAW,OACxCkB,0BAA4BnB,KAAKJ,OAAOK,UAAUC,WAAW,CAACkB,OAAQ,SAGtEC,QAFS,IAAIC,WACMC,gBAAgBJ,0BAA2B,aAC3CK,iBAAiB,UAEtCH,OAAOlB,OAAS,GAAKkB,OAAO,GAAGI,IAAK,OAE9BC,MAAQL,OAAO,GAEfM,kBAAoBC,MAAMF,MAAMD,KAChCI,WAAaF,YAAYG,iCAChB9B,KAAKL,QAAQuB,gBAAgBW,gCAEjC7B,KAAKL,QAAQoC,aAAa/B,KAAKJ,OAAOK,UAAUC,oBAG7De,SAASe,mBACVtB,MAAMuB,UAAUC,GAAGC,sBAAYC,cAAcC,QAC9CA,MAAMC,oBAKdC,mBAAmBC,mBACV5C,OAAO6C,WAAWzC,KAAKJ,OAAOM,aAAe,MAAQsC,aAAe,QAW7EE,iBAAiBC,sBACR/C,OAAOK,UAAUwC,WAAWE,iBAGrCC,wBACW,4BAAuB5C,KAAKJ,QAGvCiD,sBACW,0BAAyB7C,KAAKJ,QAGzCkD,iBACW9C,KAAKI,KAGhB2C,kBACW/C,KAAKU,MAGhBsC,mBACWhD,KAAKH"}