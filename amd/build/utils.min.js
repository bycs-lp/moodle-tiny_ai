define("tiny_ai/utils",["exports","./modal","./selectors","local_ai_manager/make_request","local_ai_manager/config","core/modal_events","editor_tiny/options","core/str","core/notification","local_ai_manager/render_infobox","tiny_ai/options","local_ai_manager/userquota","core/ajax","tiny_ai/common","core/log"],(function(_exports,_modal,_selectors,_make_request,_config,_modal_events,_options,_str,_notification,_render_infobox,_options2,_userquota,_ajax,_common,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny AI utils library.
   *
   * @module      tiny_ai/utils
   * @copyright   2024, ISB Bayern
   * @author      Dr. Peter Mayer
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.displayDialogue=void 0,_modal=_interopRequireDefault(_modal),_selectors=_interopRequireDefault(_selectors),_modal_events=_interopRequireDefault(_modal_events),_log=_interopRequireDefault(_log);const purposes={simplify:"singleprompt",translate:"singleprompt",imggen:"imggen",tts:"tts",freeprompt:"singleprompt"},getTemplateContext=async data=>Object.assign({btnIdStartSimplification:_selectors.default.buttons.btnStartSimplification,"defaultprompt-translate":"",btnIdStartTranslation:_selectors.default.buttons.btnStartTranslation,"defaultprompt-tts":"",btnIdStartTTS:_selectors.default.buttons.btnStartTTS,"defaultprompt-imggen":"Generiere bitte ein Bild mit folgenden Eigenschaften: ...",btnIdStartImgGen:_selectors.default.buttons.btnStartImgGen,btnOpenSettingsImgGen:_selectors.default.buttons.btnOpenSettingsImgGen,btnIdStartFree:_selectors.default.buttons.btnStartFree,taResult:_selectors.default.elements.taResult,spanResult:_selectors.default.elements.spanResult},data);_exports.displayDialogue=async(editor,source)=>{source===_common.selectionbarSource||source===_common.toolbarSource||_common.menubarSource;const data={},purposeConfig=await(0,_config.getPurposeConfig)();if(!purposeConfig.tenantenabled)return void await(0,_notification.alert)("Not enabled","Your ByCS admin has not enabled the AI tools yet");Object.keys(purposes).forEach((action=>{data["show"+action]=null!==purposeConfig[purposes[action]]}));const filteredPurposeConfigArray=Object.keys(purposes).filter((action=>null!==purposeConfig[purposes[action]]));data.noactionsavailable=0===filteredPurposeConfigArray.length;const usedPurposes=new Set(filteredPurposeConfigArray.map((localPurpose=>purposes[localPurpose])));for(const purpose of usedPurposes){const config=await getPurposeOptions(purpose);"tts"===purpose?(data.voices=config.voices,data.languages=config.languages):"imggen"===purpose&&(data.sizes=config.sizes)}data.showvoices=data.hasOwnProperty("voices")&&data.voices.length>0,data.showlanguages=data.hasOwnProperty("languages")&&data.languages.length>0,data.showsizes=data.hasOwnProperty("sizes")&&data.sizes.length>0;(await _modal.default.create({templateContext:await getTemplateContext(data)})).getRoot().on(_modal_events.default.save,(()=>{const selectedText=editor.selection.getContent(),newText=document.getElementById(_selectors.default.elements.taResult).value;selectedText?editor.selection.setContent(newText):editor.insertContent(newText)}));const simplifyButton=document.getElementById(_selectors.default.buttons.btnStartSimplification);simplifyButton&&simplifyButton.addEventListener("click",(()=>{const selectedText=stripHtmlTags(editor.selection.getContent());let cmdPrompt=document.getElementById(_selectors.default.elements.cmdPromptSimplify).value;const options={};options.contextid=(0,_options.getContextId)(editor),getSinglePromptResult(cmdPrompt,selectedText,options)}));const translateButton=document.getElementById(_selectors.default.buttons.btnStartTranslation);translateButton&&translateButton.addEventListener("click",(()=>{const selectedText=stripHtmlTags(editor.selection.getContent());let cmdPrompt=document.getElementById(_selectors.default.elements.cmdPromptTranslate).value;const options={};let cmdPromptend;options.contextid=(0,_options.getContextId)(editor),options.language=document.getElementById(_selectors.default.elements.translationOutputlanguage).value,options.translation=!0,options.translation&&(cmdPromptend="Translate the following text to "+options.language),cmdPrompt&&(cmdPromptend+=" "+cmdPrompt),getSinglePromptResult(cmdPromptend,selectedText,options)}));const ttsButton=document.getElementById(_selectors.default.buttons.btnStartTTS);ttsButton&&ttsButton.addEventListener("click",(()=>{const selectedText=stripHtmlTags(editor.selection.getContent());let cmdPrompt=document.getElementById(_selectors.default.elements.cmdPromptTTS).value;const options={};options.itemid=(0,_options.getDraftItemId)(editor),options.filename="tts_"+Math.random().toString(16).slice(2)+".mp3",options.languages=[document.getElementById(_selectors.default.elements.ttsOutputlanguage).value],options.voices=[document.getElementById(_selectors.default.elements.ttsOutputVoice).value],options.contextid=(0,_options.getContextId)(editor),getMP3(cmdPrompt,selectedText,options)}));const imggenButton=document.getElementById(_selectors.default.buttons.btnStartImgGen);imggenButton&&imggenButton.addEventListener("click",(()=>{const selectedText=stripHtmlTags(editor.selection.getContent());let cmdPrompt=document.getElementById(_selectors.default.elements.cmdPromptImgGen).value;const options={};options.itemid=(0,_options.getDraftItemId)(editor),options.filename="imggen_"+Math.random().toString(16).slice(2)+".png",options.sizes=[document.getElementById(_selectors.default.elements.imggensize).value],options.contextid=(0,_options.getContextId)(editor),getIMG(cmdPrompt,selectedText,options)}));const freePromptButton=document.getElementById(_selectors.default.buttons.btnStartFree);freePromptButton&&freePromptButton.addEventListener("click",(()=>{let prompt=document.getElementById(_selectors.default.elements.freerompt).value;const options={};options.contextid=(0,_options.getContextId)(editor),getSinglePromptResult(prompt,"",options)})),await(0,_render_infobox.renderInfoBox)("tiny_ai",(0,_options2.getUserId)(editor),'.tiny_ai_modal_body [data-content="local_ai_manager_infobox"]');const purposesToShowQuota=[...new Set(filteredPurposeConfigArray.map((purpose=>purposes[purpose])))];await(0,_userquota.renderUserQuota)('[data-component="tiny_ai"][data-content="local_ai_manager_userquota"]',purposesToShowQuota)};const getSinglePromptResult=async(cmdPrompt,selectedText,options)=>{const prompt=cmdPrompt+": "+selectedText;document.getElementById(_selectors.default.elements.spanResult).classList.remove("hidden"),document.getElementById(_selectors.default.elements.previewWrapperId).classList.add("hidden");const StrPleaseWait=await(0,_str.getString)("results_please_wait","tiny_ai");document.getElementById(_selectors.default.elements.taResult).value=StrPleaseWait;const requestresult=await retrieveResult("singleprompt",prompt,options);document.getElementById(_selectors.default.elements.taResult).value=null!==requestresult?requestresult.result:""},getMP3=async(cmdPrompt,selectedText,options)=>{const prompt=cmdPrompt+" "+selectedText;document.getElementById(_selectors.default.elements.spanResult).classList.add("hidden"),document.getElementById(_selectors.default.elements.previewWrapperId).classList.remove("hidden");const StrPleaseWait=await(0,_str.getString)("results_please_wait","tiny_ai");document.getElementById(_selectors.default.elements.previewSectionId).innerHTML=StrPleaseWait;const requestresult=await retrieveResult(purposes.tts,prompt,options);if(null===requestresult)return;const fileUrl=requestresult.result,node=selectedText+'<audio class="tiny_ai_audio" controls src="'+fileUrl+'" type="audio/mpeg"/>';document.getElementById(_selectors.default.elements.taResult).value=node;const audiotag=document.createElement("audio");audiotag.controls="controls",audiotag.src=fileUrl,audiotag.type="audio/mpeg",document.getElementById(_selectors.default.elements.previewSectionId).innerHTML="",document.getElementById(_selectors.default.elements.previewSectionId).appendChild(audiotag)},getIMG=async(cmdPrompt,selectedText,options)=>{const prompt=cmdPrompt;document.getElementById(_selectors.default.elements.spanResult).classList.add("hidden"),document.getElementById(_selectors.default.elements.previewWrapperId).classList.remove("hidden");const StrPleaseWait=await(0,_str.getString)("results_please_wait","tiny_ai");document.getElementById(_selectors.default.elements.previewSectionId).innerHTML=StrPleaseWait;const requestresult=await retrieveResult(purposes.imggen,prompt,options);if(null===retrieveResult)return;const fileUrl=requestresult.result,node=selectedText+'<img class="tiny_ai_img mw-100" src="'+fileUrl+'" />';document.getElementById(_selectors.default.elements.taResult).value=node;const img=document.createElement("img");img.src=fileUrl,img.classList.add("mw-100"),document.getElementById(_selectors.default.elements.previewSectionId).innerHTML="",document.getElementById(_selectors.default.elements.previewSectionId).appendChild(img)},retrieveResult=async function(purpose,prompt){let result,options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};options.component="tiny_ai";try{result=await(0,_make_request.makeRequest)(purpose,prompt,JSON.stringify(options))}catch(error){return(0,_notification.exception)(error),null}if(200!==result.code){const errorString=await(0,_str.getString)("errorwithcode","tiny_ai",result.code),error=JSON.parse(result.result);return await(0,_notification.alert)(errorString,error.message),error.hasOwnProperty("debuginfo")&&_log.default.error(error.debuginfo),null}return result},getPurposeOptions=async purpose=>{let result;try{result=await retrievePurposeOptions(purpose)}catch(error){(0,_notification.exception)(error)}return JSON.parse(result.options)},retrievePurposeOptions=purpose=>(0,_ajax.call)([{methodname:"local_ai_manager_get_purpose_options",args:{purpose:purpose}}])[0],stripHtmlTags=html=>{const span=document.createElement("span");return span.innerHTML=html,span.textContent}}));

//# sourceMappingURL=utils.min.js.map