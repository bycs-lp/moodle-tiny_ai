{"version":3,"file":"utils.min.js","sources":["../src/utils.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny AI utils library.\n *\n * @module      tiny_ai/utils\n * @copyright   2024, ISB Bayern\n * @author      Dr. Peter Mayer\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Modal from 'core/modal';\nimport AiModal from './modal';\nimport Selectors from './selectors';\nimport {makeRequest} from 'local_ai_manager/make_request';\nimport ModalEvents from 'core/modal_events';\nimport {getDraftItemId} from 'editor_tiny/options';\nimport {getString} from 'core/str';\n\n// export const handleAction = (editor) => {\n//     openingSelection = editor.selection.getBookmark();\n//     displayDialogue(editor);\n// };\n\n/**\n * Get the template context for the dialogue.\n *\n * @param {object} data\n * @returns {object} data\n */\nconst getTemplateContext = (data) => {\n    return Object.assign({}, {\n        'btnIdStartSimplification': Selectors.buttons.btnStartSimplification,\n\n        'defaultprompt-translate': \"\",\n        'btnIdStartTranslation': Selectors.buttons.btnStartTranslation,\n\n        'defaultprompt-tts': \"\",\n        'btnIdStartTTS': Selectors.buttons.btnStartTTS,\n\n        'defaultprompt-imggen': \"Generiere bitte ein Bild mit folgenden Eigenschaften: ...\",\n        'btnIdStartImgGen': Selectors.buttons.btnStartImgGen,\n        'btnOpenSettingsImgGen': Selectors.buttons.btnOpenSettingsImgGen,\n\n        'btnIdStartFree': Selectors.buttons.btnStartFree,\n\n        taResult: Selectors.elements.taResult,\n\n        spanResult: Selectors.elements.spanResult,\n    }, data);\n};\n\n/**\n * Shows and handles the dialog.\n *\n * @param {*} editor\n * @param {*} data\n */\nexport const displayDialogue = async (editor, data = {}) => {\n\n    const modal = await AiModal.create({\n        templateContext: getTemplateContext(data)\n    });\n\n    const $root = modal.getRoot();\n\n    $root.on(ModalEvents.save, () => {\n        let selectedText = editor.selection.getContent();\n        let newText = document.getElementById(Selectors.elements.taResult).value;\n        if (selectedText) {\n            editor.selection.setContent(newText);\n        } else {\n            editor.insertContent(newText);\n        }\n    });\n\n    document.getElementById(Selectors.buttons.btnStartSimplification).addEventListener('click', () => {\n        const selectedText = stripHtmlTags(editor.selection.getContent());\n        let cmdPrompt = document.getElementById(Selectors.elements.cmdPromptSimplify).value;\n        const options = {};\n        options.confirmationpersonaldata = document.getElementById(Selectors.confirmation.simplification).checked;\n        getChatResult(cmdPrompt, selectedText, options);\n    });\n\n    document.getElementById(Selectors.buttons.btnStartTranslation).addEventListener('click', () => {\n        const selectedText = stripHtmlTags(editor.selection.getContent());\n        let cmdPrompt = document.getElementById(Selectors.elements.cmdPromptTranslate).value;\n        const options = {};\n        options.language = document.getElementById(Selectors.elements.translationOutputlanguage).value;\n        options.translation = true;\n        options.confirmationpersonaldata = document.getElementById(Selectors.confirmation.translation).checked;\n\n        let cmdPromptend;\n\n        if (options.translation) {\n            cmdPromptend = 'Translate the following text to ' + options.language;\n        }\n\n        if (cmdPrompt) {\n            cmdPromptend += \" \" + cmdPrompt;\n        }\n\n        getChatResult(cmdPromptend, selectedText, options);\n    });\n\n    document.getElementById(Selectors.buttons.btnStartTTS).addEventListener('click', () => {\n        const selectedText = stripHtmlTags(editor.selection.getContent());\n        let cmdPrompt = document.getElementById(Selectors.elements.cmdPromptTTS).value;\n        const options = {};\n        options.itemid = getDraftItemId(editor);\n        options.filename = \"tts_\" + Math.random().toString(16).slice(2) + \".mp3\";\n        options.language = document.getElementById(Selectors.elements.ttsOutputlanguage).value;\n        options.voice = document.getElementById(Selectors.elements.ttsOutputVoice).value;\n        options.confirmationpersonaldata = document.getElementById(Selectors.confirmation.tts).checked;\n        getMP3(cmdPrompt, selectedText, options);\n    });\n\n    document.getElementById(Selectors.buttons.btnStartImgGen).addEventListener('click', () => {\n        const selectedText = stripHtmlTags(editor.selection.getContent());\n        let cmdPrompt = document.getElementById(Selectors.elements.cmdPromptImgGen).value;\n        const options = {};\n        options.itemid = getDraftItemId(editor);\n        options.filename = \"imggen_\" + Math.random().toString(16).slice(2) + \".png\";\n        options.imagesize = document.getElementById(Selectors.elements.imggenwidth).value;\n        options.imagesize += \"x\" + document.getElementById(Selectors.elements.imggenheight).value;\n        options.confirmationpersonaldata = document.getElementById(Selectors.confirmation.imggen).checked;\n        getIMG(cmdPrompt, selectedText, options);\n    });\n\n    document.getElementById(Selectors.buttons.btnStartFree).addEventListener('click', () => {\n        let prompt = document.getElementById(Selectors.elements.freerompt).value;\n        const options = {};\n        options.confirmationpersonaldata = document.getElementById(Selectors.confirmation.free).checked;\n        getChatResult(prompt, \"\", options);\n    });\n\n};\n\n/**\n * Get the Chat result.\n * @param {string} cmdPrompt\n * @param {string} selectedText\n * @param {object} options\n */\nconst getChatResult = async (cmdPrompt, selectedText, options) => {\n\n    let prompt = cmdPrompt + \": \" + selectedText;\n    // Shows the results box. This should happen before the real result is shown,\n    // in order to inform the user, that we are working on it.\n    document.getElementById(Selectors.elements.spanResult).classList.remove(\"hidden\");\n    document.getElementById(Selectors.elements.previewWrapperId).classList.add(\"hidden\");\n\n    if (!options.confirmationpersonaldata){\n        const StrPleaseWait = await getString('not_confirmed', 'tiny_ai').then((string) => { return string; }).catch();\n        document.getElementById(Selectors.elements.taResult).innerHTML = StrPleaseWait;\n        return;\n    }\n\n    const StrPleaseWait = await getString('results_please_wait', 'tiny_ai').then((string) => { return string; }).catch();\n    document.getElementById(Selectors.elements.taResult).value = StrPleaseWait;\n\n    retrieveResult('chat', prompt, options).then(requestresult => {\n\n        // Early exit if an error occured. Print out the error message to the output textarea.\n        if (requestresult.string == 'error') {\n            document.getElementById(Selectors.elements.taResult).value = requestresult.result;\n            return;\n        }\n\n        document.getElementById(Selectors.elements.taResult).value = requestresult.result;\n    });\n};\n\n/**\n * Get the MP3.\n * @param {string} cmdPrompt\n * @param {string} selectedText\n * @param {object} options\n */\nconst getMP3 = async (cmdPrompt, selectedText, options) => {\n    let prompt = cmdPrompt + \" \" + selectedText;\n\n    // Shows the results box. This should happen before the real result is shown,\n    // in order to inform the user, that we are working on it.\n    // document.getElementById(Selectors.elements.spanResult).classList.remove(\"hidden\");\n    document.getElementById(Selectors.elements.spanResult).classList.add(\"hidden\");\n    document.getElementById(Selectors.elements.previewWrapperId).classList.remove(\"hidden\");\n\n    if (!options.confirmationpersonaldata) {\n        const StrPleaseWait = await getString('not_confirmed', 'tiny_ai').then((string) => { return string; }).catch();\n        document.getElementById(Selectors.elements.previewSectionId).innerHTML = StrPleaseWait;\n        return;\n    }\n\n    const StrPleaseWait = await getString('results_please_wait', 'tiny_ai').then((string) => { return string; }).catch();\n    document.getElementById(Selectors.elements.previewSectionId).innerHTML = StrPleaseWait;\n\n    retrieveResult('tts', prompt, options).then(requestresult => {\n\n        // Early exit if an error occured. Print out the error message to the output textarea.\n        if (requestresult.string == 'error') {\n            document.getElementById(Selectors.elements.previewSectionId).innerHTML = requestresult.result;\n            return;\n        }\n\n        const fileUrl = requestresult.result;\n\n        // Add the audio tag to the textarea, that is inserted later to the main editor.\n        let node = selectedText + '<audio class=\"tiny_ai_audio\" controls src=\"' + fileUrl + '\" type=\"audio/mpeg\" ></span>';\n        document.getElementById(Selectors.elements.taResult).value = node;\n\n        // Finally generate the preview audio tag.\n        var audiotag = document.createElement('audio');\n        audiotag.controls = 'controls';\n        audiotag.src = fileUrl;\n        audiotag.type = 'audio/mpeg';\n        document.getElementById(Selectors.elements.previewSectionId).innerHTML = \"\";\n        document.getElementById(Selectors.elements.previewSectionId).appendChild(audiotag);\n\n    });\n};\n\n/**\n * Get the IMG.\n * @param {string} cmdPrompt\n * @param {string} selectedText\n * @param {object} options\n */\nconst getIMG = async (cmdPrompt, selectedText, options) => {\n    let prompt = cmdPrompt;\n\n    // Shows the results box. This should happen before the real result is shown,\n    // in order to inform the user, that we are working on it.\n    // document.getElementById(Selectors.elements.spanResult).classList.remove(\"hidden\");\n    document.getElementById(Selectors.elements.spanResult).classList.add(\"hidden\");\n    document.getElementById(Selectors.elements.previewWrapperId).classList.remove(\"hidden\");\n\n    if (!options.confirmationpersonaldata) {\n        const StrPleaseWait = await getString('not_confirmed', 'tiny_ai').then((string) => { return string; }).catch();\n        document.getElementById(Selectors.elements.previewSectionId).innerHTML = StrPleaseWait;\n        return;\n    }\n\n    const StrPleaseWait = await getString('results_please_wait', 'tiny_ai').then((string) => { return string; }).catch();\n    document.getElementById(Selectors.elements.previewSectionId).innerHTML = StrPleaseWait;\n\n    retrieveResult('imggen', prompt, options).then(requestresult => {\n\n        // Early exit if an error occured. Print out the error message to the output textarea.\n        if (requestresult.string == 'error') {\n            document.getElementById(Selectors.elements.previewSectionId).innerHTML = requestresult.result;\n            return;\n        }\n\n        const fileUrl = requestresult.result;\n\n        // Add the img tag to the textarea, that is inserted later to the main editor.\n        let node = selectedText + '<img class=\"tiny_ai_img\" src=\"' + fileUrl + '\" ></span>';\n        document.getElementById(Selectors.elements.taResult).value = node;\n\n        // Finally generate the preview img tag.\n        var img = document.createElement('img');\n        img.src = fileUrl;\n        document.getElementById(Selectors.elements.previewSectionId).innerHTML = \"\";\n        document.getElementById(Selectors.elements.previewSectionId).appendChild(img);\n    });\n};\n\n/**\n * Get the async answer from the LLM.\n *\n * @param {string} purpose\n * @param {string} prompt\n * @param {array} options\n * @returns {string}\n */\nconst retrieveResult = async (purpose, prompt, options = []) => {\n    let result = await makeRequest(purpose, prompt, JSON.stringify(options));\n    return result;\n};\n\nconst stripHtmlTags = (html) => {\n    // Place selected content into a temporary span and extract the plain text from it to strip HTML tags.\n    const span = document.createElement('span');\n    span.innerHTML = html;\n    return span.textContent;\n};\n"],"names":["getTemplateContext","data","Object","assign","Selectors","buttons","btnStartSimplification","btnStartTranslation","btnStartTTS","btnStartImgGen","btnOpenSettingsImgGen","btnStartFree","taResult","elements","spanResult","async","editor","modal","AiModal","create","templateContext","$root","getRoot","on","ModalEvents","save","selectedText","selection","getContent","newText","document","getElementById","value","setContent","insertContent","addEventListener","stripHtmlTags","cmdPrompt","cmdPromptSimplify","options","confirmationpersonaldata","confirmation","simplification","checked","getChatResult","cmdPromptTranslate","cmdPromptend","language","translationOutputlanguage","translation","cmdPromptTTS","itemid","filename","Math","random","toString","slice","ttsOutputlanguage","voice","ttsOutputVoice","tts","getMP3","cmdPromptImgGen","imagesize","imggenwidth","imggenheight","imggen","getIMG","prompt","freerompt","free","classList","remove","previewWrapperId","add","StrPleaseWait","then","string","catch","innerHTML","retrieveResult","requestresult","result","previewSectionId","fileUrl","node","audiotag","createElement","controls","src","type","appendChild","img","purpose","JSON","stringify","html","span","textContent"],"mappings":"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"}