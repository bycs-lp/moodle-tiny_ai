{"version":3,"file":"utils.min.js","sources":["../src/utils.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny AI utils library.\n *\n * @module      tiny_ai/utils\n * @copyright   2024, ISB Bayern\n * @author      Dr. Peter Mayer\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalEvents from 'core/modal_events';\nimport Renderer from 'tiny_ai/renderer';\nimport DataManager from 'tiny_ai/datamanager';\nimport {alert as Alert, exception as displayException} from 'core/notification';\nimport {getString} from 'core/str';\nimport {makeRequest} from 'local_ai_manager/make_request';\nimport * as BasedataHandler from 'tiny_ai/datahandler/basedata';\nimport $ from 'jquery';\nimport Log from 'core/log';\nimport EditorUtils from 'tiny_ai/editor_utils';\n\nconst objectStore = {};\n\nexport const init = async (uniqid, editor) => {\n    if (!objectStore.hasOwnProperty(uniqid)) {\n        objectStore[uniqid] = {};\n        // The order in which these objects are being created is actually pretty important, because Renderer\n        // object depends on DataManager object.\n        objectStore[uniqid].editorUtils = new EditorUtils(uniqid, editor);\n        objectStore[uniqid].datamanager = new DataManager(uniqid);\n        objectStore[uniqid].renderer = new Renderer(uniqid);\n        await objectStore[uniqid].renderer.init();\n    }\n};\n\nexport const getAiAnswer = async (prompt, purpose, options = {}) => {\n    let result = null;\n    try {\n        result = await makeRequest(purpose, prompt, options);\n    } catch (exception) {\n        await displayException(exception);\n        return;\n    }\n    if (result.code !== 200) {\n        const alertTitle = await getString('errorwithcode', 'tiny_ai', result.code);\n        const parsedResult = JSON.parse(result.result);\n        if (parsedResult.debuginfo) {\n            Log.error(parsedResult.debuginfo);\n        }\n        await errorAlert(parsedResult.message, alertTitle);\n        return null;\n    }\n    return result.result;\n};\n\nexport const errorAlert = async (message, title = null) => {\n    if (title === null) {\n        title = BasedataHandler.getTinyAiString('generalerror');\n    }\n    const alertModal = await Alert(title, message);\n    alertModal.getRoot().on(ModalEvents.hidden, () => {\n        document.querySelectorAll('button[data-action]').forEach(button => {\n            $(button).tooltip('hide');\n        });\n    });\n};\n\nexport const stripHtmlTags = (textWithTags) => {\n    // Place selected content into a temporary span and extract the plain text from it to strip HTML tags.\n    const span = document.createElement('span');\n    span.innerHTML = textWithTags;\n    return span.textContent;\n};\n\nexport const getEditorUtils = (uniqid) => {\n    return objectStore[uniqid].editorUtils;\n};\n\nexport const getRenderer = (uniqid) => {\n    return objectStore[uniqid].renderer;\n};\n\nexport const getDatamanager = (uniqid) => {\n    return objectStore[uniqid].datamanager;\n};\n\nexport const getCurrentModalUniqId = (element) => {\n    return element.closest('[data-tiny_ai_uniqid]').dataset['tiny_ai_uniqid'];\n};\n"],"names":["objectStore","async","uniqid","editor","hasOwnProperty","editorUtils","EditorUtils","datamanager","DataManager","renderer","Renderer","init","prompt","purpose","options","result","exception","code","alertTitle","parsedResult","JSON","parse","debuginfo","error","errorAlert","message","title","BasedataHandler","getTinyAiString","alertModal","getRoot","on","ModalEvents","hidden","document","querySelectorAll","forEach","button","tooltip","textWithTags","span","createElement","innerHTML","textContent","element","closest","dataset"],"mappings":";;;;;;;;0rCAmCMA,YAAc,iBAEAC,MAAOC,OAAQC,UAC1BH,YAAYI,eAAeF,UAC5BF,YAAYE,QAAU,GAGtBF,YAAYE,QAAQG,YAAc,IAAIC,sBAAYJ,OAAQC,QAC1DH,YAAYE,QAAQK,YAAc,IAAIC,qBAAYN,QAClDF,YAAYE,QAAQO,SAAW,IAAIC,kBAASR,cACtCF,YAAYE,QAAQO,SAASE,8BAIhBV,eAAOW,OAAQC,aAASC,+DAAU,GACrDC,OAAS,SAETA,aAAe,6BAAYF,QAASD,OAAQE,SAC9C,MAAOE,6BACC,2BAAiBA,cAGP,MAAhBD,OAAOE,KAAc,OACfC,iBAAmB,kBAAU,gBAAiB,UAAWH,OAAOE,MAChEE,aAAeC,KAAKC,MAAMN,OAAOA,eACnCI,aAAaG,wBACTC,MAAMJ,aAAaG,iBAErBE,WAAWL,aAAaM,QAASP,YAChC,YAEJH,OAAOA,cAGLS,WAAavB,eAAOwB,aAASC,6DAAQ,KAChC,OAAVA,QACAA,MAAQC,gBAAgBC,gBAAgB,uBAEtCC,iBAAmB,uBAAMH,MAAOD,SACtCI,WAAWC,UAAUC,GAAGC,sBAAYC,QAAQ,KACxCC,SAASC,iBAAiB,uBAAuBC,SAAQC,6BACnDA,QAAQC,QAAQ,qEAKAC,qBAEpBC,KAAON,SAASO,cAAc,eACpCD,KAAKE,UAAYH,aACVC,KAAKG,qCAGezC,QACpBF,YAAYE,QAAQG,iCAGHH,QACjBF,YAAYE,QAAQO,iCAGAP,QACpBF,YAAYE,QAAQK,2CAGOqC,SAC3BA,QAAQC,QAAQ,yBAAyBC,QAAzC"}