{"version":3,"file":"utils.min.js","sources":["../src/utils.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny AI utils library.\n *\n * @module      tiny_ai/utils\n * @copyright   2024, ISB Bayern\n * @author      Dr. Peter Mayer\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport AiModal from 'tiny_ai/modal';\nimport ModalEvents from 'core/modal_events';\nimport {getUserId} from 'tiny_ai/options';\nimport {constants} from 'tiny_ai/constants';\nimport {selectionbarSource, toolbarSource, menubarSource} from 'tiny_ai/common';\nimport * as Renderer from 'tiny_ai/renderer';\nimport DataManager from 'tiny_ai/datamanager';\nimport {exception as displayException} from 'core/notification';\nimport {getString} from 'core/str';\nimport {makeRequest} from 'local_ai_manager/make_request';\nimport {getDraftItemId as getDraftItemIdTinyCore, getContextId as getContextItemIdTinyCore} from 'editor_tiny/options';\n\n\nlet userId = null;\nlet modal = null;\nlet mode = null;\nlet editor = null;\n\nexport const init = async (editorObject) => {\n    editor = editorObject;\n    userId = getUserId(editor);\n}\n\n/**\n * Shows and handles the dialog.\n *\n * @param {string} source the different sources from where the modal is being created, defined in common module\n */\nexport const displayDialogue = async (source) => {\n    if (source === selectionbarSource) {\n        mode = constants.modalModes.selection;\n    } else if (source === toolbarSource || source === menubarSource) {\n        mode = constants.modalModes.general;\n    }\n\n\n    // We initially render the modal without content, because we need to rerender it anyway.\n    modal = await AiModal.create({\n        templateContext: {\n            classes: 'tiny_ai-modal--dialog',\n            headerclasses: 'tiny_ai-modal--header'\n        }\n    });\n\n    if (mode === constants.modalModes.selection) {\n        console.log(editor)\n        DataManager.setSelection(editor.selection.getContent());\n    }\n    await Renderer.init(modal, userId);\n    // Unfortunately, the modal will not execute any JS code in the template, so we need to rerender the modal as a whole again.\n    await Renderer.renderStart(mode);\n    modal.getRoot().on(ModalEvents.outsideClick, event => {\n        event.preventDefault();\n    });\n};\n\nexport const getAiAnswer = async(prompt, purpose, options = {}) => {\n    let result = null;\n    try {\n        result = await makeRequest(purpose, prompt, options);\n    } catch (exception) {\n        displayException(exception);\n    }\n    if (result.code !== 200) {\n        const errorString = await getString('errorwithcode', 'tiny_ai', result.code);\n        await alert(errorString, result.result);\n        return null;\n    }\n    return result.result;\n}\n\nexport const insertAfterContent = (textToInsert) => {\n    editor.setContent(editor.getContent() + '<p>' + textToInsert + '</p>');\n}\n\nexport const replaceSelection = (textToReplace) => {\n    editor.selection.setContent(textToReplace);\n}\n\nexport const destroyModal = () => {\n    modal.destroy();\n}\n\nexport const getDraftItemId = () => {\n    return getDraftItemIdTinyCore(editor);\n}\n\nexport const getContextId = () => {\n    return getContextItemIdTinyCore(editor);\n}\n\nexport const getMode = () => {\n    return mode;\n};\n"],"names":["userId","modal","mode","editor","async","editorObject","source","selectionbarSource","constants","modalModes","selection","toolbarSource","menubarSource","general","AiModal","create","templateContext","classes","headerclasses","console","log","setSelection","getContent","Renderer","init","renderStart","getRoot","on","ModalEvents","outsideClick","event","preventDefault","prompt","purpose","options","result","exception","code","errorString","alert","textToInsert","setContent","textToReplace","destroy"],"mappings":";;;;;;;;2jCAqCIA,OAAS,KACTC,MAAQ,KACRC,KAAO,KACPC,OAAS,mBAEOC,MAAAA,eAChBD,OAASE,aACTL,QAAS,sBAAUG,kCAQQC,MAAAA,SACvBE,SAAWC,2BACXL,KAAOM,qBAAUC,WAAWC,UACrBJ,SAAWK,uBAAiBL,SAAWM,wBAC9CV,KAAOM,qBAAUC,WAAWI,SAKhCZ,YAAca,eAAQC,OAAO,CACzBC,gBAAiB,CACbC,QAAS,wBACTC,cAAe,2BAInBhB,OAASM,qBAAUC,WAAWC,YAC9BS,QAAQC,IAAIjB,6BACAkB,aAAalB,OAAOO,UAAUY,qBAExCC,SAASC,KAAKvB,MAAOD,cAErBuB,SAASE,YAAYvB,MAC3BD,MAAMyB,UAAUC,GAAGC,sBAAYC,cAAcC,QACzCA,MAAMC,0CAIa3B,eAAM4B,OAAQC,aAASC,+DAAU,GACpDC,OAAS,SAETA,aAAe,6BAAYF,QAASD,OAAQE,SAC9C,MAAOE,uCACYA,cAED,MAAhBD,OAAOE,KAAc,OACfC,kBAAoB,kBAAU,gBAAiB,UAAWH,OAAOE,mBACjEE,MAAMD,YAAaH,OAAOA,QACzB,YAEJA,OAAOA,oCAGiBK,eAC/BrC,OAAOsC,WAAWtC,OAAOmB,aAAe,MAAQkB,aAAe,mCAGlCE,gBAC7BvC,OAAOO,UAAU+B,WAAWC,sCAGJ,KACxBzC,MAAM0C,mCAGoB,KACnB,4BAAuBxC,8BAGN,KACjB,0BAAyBA,yBAGb,IACZD"}