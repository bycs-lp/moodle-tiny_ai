{"version":3,"file":"start.min.js","sources":["../../src/datahandler/start.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {constants} from '../constants';\nimport * as BasedataHandler from 'tiny_ai/datahandler/basedata';\nimport {getAiConfig} from 'local_ai_manager/config';\nimport {getMode} from 'tiny_ai/utils';\n\n\n/**\n * Tiny AI data handler for start page.\n *\n * @module      tiny_ai/datahandler/start\n * @copyright   2024, ISB Bayern\n * @author      Philipp Memmel\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst StartHandler = new _StartHandler();\n\nclass _StartHandler {\n\n    aiConfig = null;\n\n    async init() {\n        this.aiConfig = await getAiConfig();\n    }\n\n    getPurposeConfig = (tool) => {\n        if (this.aiConfig === null) {\n            throw new Error('Coding error: init function was not called before accessing this.getPurposeConfig!');\n        }\n        console.log(tool)\n        const toolPurpose = constants.toolPurposeMapping[tool];\n        return this.aiConfig.purposes.filter(purpose => purpose['purpose'] === toolPurpose)[0];\n    }\n\n    isTinyAiDisabled() {\n        if (!this.aiConfig.tenantenabled) {\n            return 'TENANT NICHT AKTIV, BYCS ADMIN MUSS AKTIVIEREN';\n        }\n        if (!this.aiConfig.userconfirmed) {\n            return 'NICHT BESTÄTIGT, HIER IST DER LINK: /local/ai_manager/confirm_ai_usage.php';\n        }\n        if (this.aiConfig.userlocked) {\n            return 'IHR NUTZER WURDE DURCH DEN BYCS ADMIN GESPERRT';\n        }\n        return '';\n    }\n\n    isToolDisabled(tool) {\n        if (this.isTinyAiDisabled()) {\n            return this.isTinyAiDisabled();\n        }\n        const purposeInfo = this.getPurposeConfig(tool);\n        if (!purposeInfo.isconfigured) {\n            return 'FÜR DIESEN ZWECK IST KEIN KI-TOOL HINTERLEGT, BITTE MIT DEM BYCS ADMIN SPRECHEN';\n        }\n        if (purposeInfo.limitreached) {\n            return 'SIE HABEN BEREITS DAS LIMIT DER KI-NUTZUNG IM ENTSPRECHENDEN ZEITRAUM ERREICHT.'\n                + ' BITTE WARTEN, BIS DER COUNTER ZURÜCKGESETZT WIRD';\n        }\n\n        if (getMode() === constants.modalModes.selection) {\n            return ['audiogen', 'imggen'].includes(tool) ? 'DIESES TOOL IST NUR VERFÜGBAR, WENN TEXT MARKIERT WURDE' : '';\n        } else if (getMode() === constants.modalModes.general) {\n            return ['summarize', 'translate', 'describe', 'tts'].includes(tool) ? 'DIESES TOOL IST NUR VERFÜGBAR, WENN KEIN TEXT MARKIERT WURDE' : '';\n        }\n    }\n\n    // TODO Test if this logic is correct\n    isToolHidden(tool) {\n        const purposeInfo = this.getPurposeConfig(tool);\n        // If the tenant is not allowed the plugin is being disabled completely, so we do not need\n        // to check this case here.\n        if (this.aiConfig.role === 'role_basic') {\n            if (!this.aiConfig.tenantenabled) {\n                return true;\n            }\n            if (!purposeInfo.isconfigured) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    getTemplateContext() {\n        let toolButtons = [];\n\n        if (!this.isToolHidden('summarize')) {\n            toolButtons.push({\n                toolname: 'summarize',\n                tool: BasedataHandler.getTinyAiString('toolname_summarize'),\n                description: BasedataHandler.getTinyAiString('toolname_summarize_extension'),\n                customicon: true,\n                iconname: 'shorten',\n                disabled: this.isToolDisabled('summarize').length > 0,\n                action: 'loadsummarize'\n            });\n        }\n        if (!this.isToolHidden('translate')) {\n            toolButtons.push({\n                toolname: 'translate',\n                tool: BasedataHandler.getTinyAiString('toolname_translate'),\n                description: BasedataHandler.getTinyAiString('toolname_translate_extension'),\n                iconname: 'language',\n                iconstyle: 'solid',\n                disabled: this.isToolDisabled('translate').length > 0,\n                action: 'loadtranslate'\n            });\n        }\n        if (!this.isToolHidden('describe')) {\n            toolButtons.push({\n                toolname: 'describe',\n                tool: BasedataHandler.getTinyAiString('toolname_describe'),\n                description: BasedataHandler.getTinyAiString('toolname_describe_extension'),\n                customicon: true,\n                iconname: 'extend',\n                disabled: this.isToolDisabled('describe').length > 0,\n                action: 'loaddescribe'\n            });\n        }\n        if (!this.isToolHidden('tts')) {\n            toolButtons.push({\n                toolname: 'tts',\n                tool: BasedataHandler.getTinyAiString('toolname_tts'),\n                description: BasedataHandler.getTinyAiString('toolname_tts_extension'),\n                iconstyle: 'solid',\n                iconname: 'microphone',\n                disabled: this.isToolDisabled('tts').length > 0,\n                action: 'loadtts'\n            });\n        }\n        if (!this.isToolHidden('audiogen')) {\n            toolButtons.push({\n                toolname: 'audiogen',\n                tool: BasedataHandler.getTinyAiString('toolname_audiogen'),\n                iconstyle: 'solid',\n                iconname: 'microphone',\n                disabled: this.isToolDisabled('audiogen').length > 0,\n                action: 'loadaudiogen'\n            });\n            console.log(this.isToolDisabled('audiogen'));\n        }\n        if (!this.isToolHidden('imggen')) {\n            toolButtons.push({\n                toolname: 'imggen',\n                tool: BasedataHandler.getTinyAiString('toolname_imggen'),\n                iconstyle: 'solid',\n                iconname: 'image',\n                disabled: this.isToolDisabled('imggen').length > 0,\n                action: 'loadimggen'\n            });\n        }\n        // We sort the not disabled tools to the top while keeping the groups \"disabled tools\" and \"not disabled tools\" in the same order inside the groups.\n        toolButtons.sort((a, b) => {\n            if (a.disabled && !b.disabled) {\n                return 1;\n            } else if (b.disabled && !a.disabled) {\n                return -1;\n            } else {\n                return 0;\n            }\n        })\n\n        const templateContext = {\n            showIcon: true,\n            modal_headline: BasedataHandler.getTinyAiString('mainselection_heading'),\n            action: 'loadfreeprompt',\n            modal_buttons: toolButtons,\n            freeprompthidden: true\n        };\n        Object.assign(templateContext, BasedataHandler.getInputContext());\n        if (this.isTinyAiDisabled()) {\n            templateContext.input[0].disabled = true;\n            templateContext.input[0].hasError = true;\n            templateContext.input[0].errorMessage = this.isTinyAiDisabled();\n        }\n        if (this.isToolDisabled('freeprompt')) {\n            templateContext.input[0].disabled = true;\n        }\n        return templateContext;\n    }\n}\n\nexport default StartHandler;\n"],"names":["StartHandler","tool","this","aiConfig","Error","console","log","toolPurpose","constants","toolPurposeMapping","purposes","filter","purpose","isTinyAiDisabled","tenantenabled","userconfirmed","userlocked","isToolDisabled","purposeInfo","getPurposeConfig","isconfigured","limitreached","modalModes","selection","includes","general","isToolHidden","role","getTemplateContext","toolButtons","push","toolname","BasedataHandler","getTinyAiString","description","customicon","iconname","disabled","length","action","iconstyle","sort","a","b","templateContext","showIcon","modal_headline","modal_buttons","freeprompthidden","Object","assign","getInputContext","input","hasError","errorMessage"],"mappings":"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"}